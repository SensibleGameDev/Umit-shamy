<!DOCTYPE html>
<html lang="kk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}{% endblock %} - “Æ–º—ñ—Ç —à–∞–º—ã</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
</head>
<body>
    <header>
        <nav class="container">
            <a href="{{ url_for('index') }}" class="logo">
                <img src="{{ url_for('static', filename='logo.jpg') }}" alt="“Æ–º—ñ—Ç —à–∞–º—ã –ª–æ–≥–æ" class="logo-img">
                <span>“Æ–º—ñ—Ç —à–∞–º—ã</span>
            </a>
            <ul>
                <li><a href="{{ url_for('index') }}">–ë–∞—Å—Ç—ã –±–µ—Ç</a></li>
                <li><a href="{{ url_for('emotional_support') }}">–≠–º–æ—Ü–∏—è–ª—ã“õ “õ–æ–ª–¥–∞—É</a></li>
                <li><a href="{{ url_for('support_wall') }}">“ö–æ–ª–¥–∞—É “õ–∞–±—ã—Ä“ì–∞—Å—ã</a></li>
                <li><a href="{{ url_for('psychological_support') }}">–ü—Å–∏—Ö–æ–ª–æ–≥–∏—è–ª—ã“õ “õ–æ–ª–¥–∞—É</a></li>
                <li><a href="{{ url_for('urgent_help') }}" class="sos-nav-btn">SOS üÜò</a></li>
            </ul>
        </nav>
    </header>

    <main class="container">
        {% block content %}{% endblock %}
    </main>

    <!-- --- –ß–ê–¢-–ë–û–¢ –í–ò–î–ñ–ï–¢–Ü --- -->
    <button id="chat-toggle-btn" class="chat-toggle-btn">
        üí¨ –ö”©–º–µ–∫—à—ñ "“Æ–º—ñ—Ç"
    </button>

    <div id="chat-widget" class="chat-widget hidden">
        <div class="chat-header">
            <div class="chat-title">
                <span>ü§ñ “Æ–º—ñ—Ç</span>
                <small>–í–∏—Ä—Ç—É–∞–ª–¥—ã –∫”©–º–µ–∫—à—ñ</small>
            </div>
            <button id="chat-close-btn" class="chat-close-btn">&times;</button>
        </div>
        <div id="chat-messages" class="chat-messages">
            <div class="message bot-message">
                –°”ô–ª–µ–º! –ú–µ–Ω—ñ“£ –∞—Ç—ã–º - “Æ–º—ñ—Ç. –°–∞“ì–∞–Ω “õ–∞–ª–∞–π –∫”©–º–µ–∫—Ç–µ—Å–µ –∞–ª–∞–º—ã–Ω? –ö”©“£—ñ–ª-–∫“Ø–π—ñ“£ “õ–∞–ª–∞–π?
            </div>
        </div>
        <div class="chat-input-area">
            <input type="text" id="chat-input" placeholder="–•–∞–±–∞—Ä–ª–∞–º–∞ –∂–∞–∑—ã“£—ã–∑..." autocomplete="off">
            <button id="chat-send-btn">‚û§</button>
        </div>
    </div>
    <!-- --- –ß–ê–¢-–ë–û–¢ –ê–Ø“ö–¢–ê–õ–î–´ --- -->

    <footer>
        <div class="container">
            <p>&copy; 2025 "“Æ–º—ñ—Ç —à–∞–º—ã" - –û“õ—É—à—ã–ª–∞—Ä“ì–∞ –∞—Ä–Ω–∞–ª“ì–∞–Ω “õ–æ–ª–¥–∞—É –ø–ª–∞—Ç—Ñ–æ—Ä–º–∞—Å—ã.</p>
        </div>
    </footer>

    <!-- JAVASCRIPT -->
    <script>
        const toggleBtn = document.getElementById('chat-toggle-btn');
        const closeBtn = document.getElementById('chat-close-btn');
        const chatWidget = document.getElementById('chat-widget');
        const sendBtn = document.getElementById('chat-send-btn');
        const chatInput = document.getElementById('chat-input');
        const messagesContainer = document.getElementById('chat-messages');

        // –ß–∞—Ç—Ç—ã –∞—à—É/–∂–∞–±—É
        toggleBtn.addEventListener('click', () => {
            chatWidget.classList.remove('hidden');
            toggleBtn.classList.add('hidden');
            chatInput.focus();
        });

        closeBtn.addEventListener('click', () => {
            chatWidget.classList.add('hidden');
            toggleBtn.classList.remove('hidden');
        });

        // –•–∞–±–∞—Ä–ª–∞–º–∞ “õ–æ—Å—É —Ñ—É–Ω–∫—Ü–∏—è—Å—ã
        function addMessage(text, sender) {
            const div = document.createElement('div');
            div.classList.add('message', sender === 'user' ? 'user-message' : 'bot-message');
            div.textContent = text;
            messagesContainer.appendChild(div);
            messagesContainer.scrollTop = messagesContainer.scrollHeight; // –¢”©–º–µ–Ω–≥–µ –∞–π–Ω–∞–ª–¥—ã—Ä—É
        }

        // –•–∞–±–∞—Ä–ª–∞–º–∞ –∂—ñ–±–µ—Ä—É
        async function sendMessage() {
            const text = chatInput.value.trim();
            if (!text) return;

            // 1. –ü–∞–π–¥–∞–ª–∞–Ω—É—à—ã —Ö–∞–±–∞—Ä–ª–∞–º–∞—Å—ã–Ω –∫”©—Ä—Å–µ—Ç—É
            addMessage(text, 'user');
            chatInput.value = '';
            chatInput.disabled = true; // –ñ–∞—É–∞–ø –∫–µ–ª–≥–µ–Ω—à–µ –±“±“ì–∞—Ç—Ç–∞—É

            // "–ñ–∞–∑—ã–ø –∂–∞—Ç—ã—Ä..." –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã–Ω “õ–æ—Å—É“ì–∞ –±–æ–ª–∞–¥—ã (–æ–ø—Ü–∏–æ–Ω–∞–ª–¥—ã)
            const loadingDiv = document.createElement('div');
            loadingDiv.classList.add('message', 'bot-message', 'loading');
            loadingDiv.textContent = '...';
            messagesContainer.appendChild(loadingDiv);

            try {
                // 2. –°–µ—Ä–≤–µ—Ä–≥–µ (API) –∂—ñ–±–µ—Ä—É
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message: text })
                });

                const data = await response.json();
                
                // Loading-–¥—ñ ”©—à—ñ—Ä—É
                messagesContainer.removeChild(loadingDiv);

                // 3. –ë–æ—Ç –∂–∞—É–∞–±—ã–Ω –∫”©—Ä—Å–µ—Ç—É
                if (data.reply) {
                    addMessage(data.reply, 'bot');
                } else {
                    addMessage('“ö–∞—Ç–µ —à—ã“õ—Ç—ã.', 'bot');
                }

            } catch (error) {
                messagesContainer.removeChild(loadingDiv);
                addMessage('–ë–∞–π–ª–∞–Ω—ã—Å “õ–∞—Ç–µ—Å—ñ. “ö–∞–π—Ç–∞ –∫”©—Ä—ñ“£—ñ–∑.', 'bot');
            } finally {
                chatInput.disabled = false;
                chatInput.focus();
            }
        }

        sendBtn.addEventListener('click', sendMessage);
        chatInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') sendMessage();
        });
    </script>
</body>

</html>
